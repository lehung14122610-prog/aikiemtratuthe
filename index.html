<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Pose Classifier AI</title>
    <style>
        /* Thêm box-sizing để tính toán kích thước không bị vỡ */
        * { box-sizing: border-box; } 

        body{font-family:'Segoe UI',sans-serif;background:#f0f4f8;margin:0;display:flex;flex-direction:column;min-height:100vh;color:#333}
        header{background:#fff;padding:15px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.05)}
        .logo{color:#3b82f6;font-weight:700;font-size:1.2rem;display:flex;align-items:center;gap:10px}
        .img-logo{height:30px;width:auto}
        nav a{text-decoration:none;color:#666;margin-left:15px;font-size:0.95rem}
        nav a.active{color:#3b82f6;font-weight:700}
        main{flex:1;padding:20px 10px;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .card{background:#fff;border-radius:12px;padding:20px;width:100%;max-width:500px;box-shadow:0 4px 15px rgba(0,0,0,.05);text-align:center}
        h1{color:#3b82f6;margin:0 0 15px;font-size:1.5rem}
        .view-box{width:100%;aspect-ratio:1/1;background:#000;border-radius:10px;margin-bottom:20px;position:relative;display:flex;justify-content:center;align-items:center;overflow:hidden}
        canvas{width:100%;height:100%;object-fit:cover;display:none}
        #hold{color:#888;display:flex;flex-direction:column;align-items:center} 
        .img-placeholder{width:64px;height:64px;margin-bottom:10px;opacity:0.5}
        .img-loading{width:40px;height:40px}
        
        .btns-container {
            position: relative;
            width: 100%;
            height: 40px; 
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }
        
        .btns {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center; 
            gap: 10px; 
            transition: opacity 0.2s;
        }

        button{
            padding:10px 15px;
            border:none;
            border-radius:6px;
            color:#fff;
            font-weight:600;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            font-size:0.9rem;
            white-space:nowrap;
        }

        #live-btns {
            gap: 15px; 
        }

        .btn-icon{width:16px;height:16px;filter:brightness(0) invert(1)}
        .g{background:#10b981}.gy{background:#6b7280}.r{background:#ef4444}.o{background:#f59e0b}
        .res{background:#f1f5f9;padding:10px;margin-bottom:6px;border-radius:5px;border-left:4px solid #3b82f6;display:flex;justify-content:space-between;font-size:0.95rem}
        footer{font-size:.8rem;color:#999;text-align:center;padding:15px;background:#fff}
        #load{display:none;position:absolute}
        
        .qr-section { 
            text-align: center; 
            margin-top: 20px; 
            padding: 15px;
            border-radius: 12px;
            background: #fff;
            box-shadow:0 4px 15px rgba(0,0,0,.05);
            max-width: 500px;
            width: 100%;
        }
        .qr-section h2 { 
            color: #3b82f6; 
            font-size: 1.1rem;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .qr-img { 
            width: 120px; 
            height: 120px; 
            padding: 5px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 5px; 
        }
        .qr-note { 
            font-size: 0.8rem; 
            color: #888; 
            font-style: italic; 
            margin-bottom: 0; 
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" style="text-decoration: none;">
            <div class="logo">
                <img src="icon/logo.png" alt="Logo" class="img-logo" onerror="this.style.display='none'"> 
                Pose Classifier AI
            </div>
        </a>
        <nav><a href="index.html" class="active">Trang Chủ</a><a href="about.html">Giới Thiệu</a></nav>
    </header>
    <main>
        <div class="card">
            <h1>Nhận Diện Tư Thế</h1>
            <div class="view-box">
                <div id="hold">
                    <img src="icon/camera.png" alt="Camera" class="img-placeholder">
                    <p>Sẵn sàng</p>
                </div>
                <canvas id="cv"></canvas>
                <div id="load">
                    <img src="icon/loading.gif" alt="Loading..." class="img-loading">
                </div>
            </div>
            
            <div class="btns-container">
                <div id="normal-btns" class="btns">
                    <input type="file" id="up" hidden accept="image/*" onchange="hImg(this)">
                    
                    <button class="g" onclick="$('up').click()">
                        <img src="icon/icon-upload.png" class="btn-icon"> Tải ảnh
                    </button>
                    
                    <button id="bs" class="gy" onclick="init()">
                        <img src="icon/icon-video.png" class="btn-icon"> Mở cam
                    </button>

                    <button id="btnSnd" class="g" onclick="toggleSound()">
                        <img id="imgSnd" src="icon/icon-sound-on.png" class="btn-icon"> 
                        <span id="txtSnd">Bật tiếng</span>
                    </button>
                </div>

                <div id="live-btns" class="btns" style="display:none;">
                    <button id="bp" class="r" onclick="stop()">
                        <img src="icon/icon-stop.png" class="btn-icon"> Dừng
                    </button>
                    <button id="bw" class="o" onclick="swCam()">
                        <img src="icon/icon-switch.png" class="btn-icon"> Đổi cam
                    </button>
                </div>
            </div>
            
            <div id="lbl"></div>
        </div>

        <div class="qr-section">
            <h2>Truy cập trên thiết bị khác</h2>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://lehung14122610-prog.github.io/aikiemtratuthe/" alt="QR Code" class="qr-img">
            <p class="qr-note">Quét để mở ứng dụng trên điện thoại</p>
        </div>
    </main>
    <footer>© 2025 Dự án AI Giám Sát Tư Thế. Thực hiện bởi Lê Hưng và Lê Dũng.</footer>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    
    <script>
        const U = "./my_model/", $ = id => document.getElementById(id);
        const WRONG_LABEL = "Sai"; 
        const audFalse = new Audio('audio/false.mp3');
        let wrongStartTime = 0; 
        const ALERT_DELAY = 4000; 
        const MIN_WRONG_PROB = 0.7;
        let isSoundOn = true; 
        let m, wc, ctx, max, isRun = false, face = "user", lastT = 0;

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = $("btnSnd");
            const txt = $("txtSnd");
            const img = $("imgSnd");
            
            if (isSoundOn) {
                btn.className = "g";
                txt.innerText = "Bật tiếng";
                img.src = "icon/icon-sound-on.png";
            } else {
                btn.className = "gy";
                txt.innerText = "Tắt tiếng";
                img.src = "icon/icon-sound-off.png";
                audFalse.pause();
                audFalse.currentTime = 0;
            }
        }

        async function load() {
            if (m) return true;
            $("load").style.display = "block";
            try {
                m = await tmPose.load(U + "model.json", U + "metadata.json");
                max = m.getTotalClasses();
                $("load").style.display = "none";
                return true;
            } catch { $("load").style.display = "none"; return false; }
        }

        async function init() {
            if (!await load()) return;
            if (wc && isRun) stop();
            try {
                wc = new tmPose.Webcam(500, 500, face === "user");
                await wc.setup({ facingMode: face });
                await wc.play();
                isRun = true;
                setCvs(500, 500);
                ui(true);
                wrongStartTime = 0;
                requestAnimationFrame(loop);
            } catch {}
        }

        async function loop() {
            if (!isRun) return;
            wc.update();
            const { pose, posenetOutput } = await m.estimatePose(wc.canvas);
            ctx.drawImage(wc.canvas, 0, 0, $("cv").width, $("cv").height);
            if(pose) {
                tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
                tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
            }
            if (Date.now() - lastT > 500) { 
                await predictResult(posenetOutput); 
                lastT = Date.now();
            }
            requestAnimationFrame(loop);
        }

        async function predictResult(posenetOutput) {
            const p = await m.predict(posenetOutput);
            let bestClass = "", maxProb = 0, html = "";
            
            for (let i = 0; i < max; i++) {
                let prob = p[i].probability;
                let className = p[i].className;
                if (prob > maxProb) { maxProb = prob; bestClass = className; }
                html += `<div class="res"><span>${className}</span><b>${(prob*100).toFixed(0)}%</b></div>`;
            }
            $("lbl").innerHTML = html;

            if (bestClass === WRONG_LABEL && maxProb > MIN_WRONG_PROB) { 
                if (wrongStartTime === 0) {
                    wrongStartTime = Date.now();
                } else if (Date.now() - wrongStartTime > ALERT_DELAY) {
                    if (isSoundOn) {
                        audFalse.play().catch(e => {});
                    }
                    wrongStartTime = 0; 
                }
            } else {
                wrongStartTime = 0; 
            }
        }

        async function hImg(inp) {
            if (!inp.files[0] || !await load()) return;
            stop();
            const img = new Image();
            img.src = URL.createObjectURL(inp.files[0]);
            img.onload = async () => {
                setCvs(img.width, img.height);
                ctx.drawImage(img, 0, 0, $("cv").width, $("cv").height);
                ui(true); 
                
                // Khi tải ảnh thì ẩn nút live và hiện nút thường (để có thể tải ảnh khác)
                $("live-btns").style.display = "none";
                $("normal-btns").style.display = "flex";
                
                const { pose, posenetOutput } = await m.estimatePose(img);
                if(pose) {
                    tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
                    tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
                }
                await predictResult(posenetOutput);
            }
        }

        function setCvs(w, h) {
            const c = $("cv"); c.width = w; c.height = h;
            ctx = c.getContext("2d"); c.style.display = "block"; $("hold").style.display = "none";
        }

        function ui(live) {
            $("normal-btns").style.display = live ? "none" : "flex";
            $("live-btns").style.display = live ? "flex" : "none";
        }

        async function stop() {
            if (wc && isRun) { wc.stop(); isRun = false; }
            ui(false); 
            $("cv").style.display = "none"; 
            $("hold").style.display = "flex"; 
            $("lbl").innerHTML = "";
            wrongStartTime = 0; 
        }

        async function swCam() {
            if (!isRun) return;
            face = face === "user" ? "environment" : "user";
            await init();
        }
    </script>
</body>
</html>